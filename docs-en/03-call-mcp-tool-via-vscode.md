# Integration with Visual Studio Code

Visual Studio Code (VS Code) is an AI agent that adopted CIMD early.
In this final chapter, you will connect from VS Code to an MCP server protected by your own authorization server and verify that the agent can call tools.
If everything up to this point is implemented, CIMD client registration, token acquisition, and MCP server connection should all work.

## MCP Server Implementation

The MCP server is implemented in [/apps/mcp-server/src/index.ts](/apps/mcp-server/src/index.ts) using `@hono/mcp`.
Due to a bug in `@modelcontextprotocol/sdk`, the Protected Resource Metadata generated by `@hono/mcp` is not correct, so metadata generation is implemented separately (see [issue #1753](https://github.com/honojs/middleware/issues/1753)).
You also need to implement token validation and 401 Unauthorized handling yourself. This part is implemented in [bearer-guard.ts](/apps/mcp-server/src/auth/bearer-guard.ts).

## Connect to the MCP Server

There are multiple ways to connect to an MCP server, but this workshop uses workspace settings ([/.vscode/mcp.json](/.vscode/mcp.json)).
It is already included in this sample repository, so open this repository in VS Code and open [/.vscode/mcp.json](/.vscode/mcp.json).

When opened, a Start button appears above `demo-mcp-server`.

![start mcp server](../img/03-call-mcp-tool-via-vscode/start-mcp.png)

Click Start. A dialog like below appears, then click Allow.

![start authorization](../img/03-call-mcp-tool-via-vscode/start-authorization.png)

From the MCP server's 401 Unauthorized response (`WWW-Authenticate`) and Protected Resource Metadata, VS Code accesses authorization server metadata. If your authorization server is correctly implemented, VS Code attempts a CIMD authorization request.

![authorization request](../img/03-call-mcp-tool-via-vscode/authorization-request.png)

> Note: Confirm that `client_id` starts with `https%3A%2F%2Fvscode...`.

Click Open in the dialog to have the browser send the authorization request to your authorization server. If implemented correctly, a consent screen should appear.

In the sample implementation, the following screen is shown.

![consent screen](../img/03-call-mcp-tool-via-vscode/consent-screen.png)

After completing consent and returning to VS Code, the UI changes to indicate that the MCP server is running and that two tools are available.

![connected mcp server](../img/03-call-mcp-tool-via-vscode/connected-mcp.png)

## Calling from GitHub Copilot

Run `Chat: Open Chat` from the VS Code command palette.
In chat, issue an instruction that explicitly uses the MCP server and verify the server works.

> Call the #echo tool with the message "Hello world".

If it works correctly, output similar to the following is expected.

![chat result](../img/03-call-mcp-tool-via-vscode/chat-result.png)

You can also try the Greet tool in the same way.

> Call the #greet tool.

If you receive a response based on claims embedded in the access token, it is successful.

## If You Cannot Connect

Below are common failure patterns when MCP server connection does not work.

### Metadata Issues

If the authorization server is not correctly implemented, you may see an error or a dialog asking for a client ID.

![error dialog as does not support CIMD](../img/03-call-mcp-tool-via-vscode/error-dialog.png)

Connection logs for MCP server startup are shown in the OUTPUT panel. Check them when errors occur.

![OUTPUT panel error example (metadata not found)](../img/03-call-mcp-tool-via-vscode/output-panel-error-example.png)

A warning such as `[warning] Error fetching authorization server metadata: Error: Failed to fetch authorization server metadata from https://<ngrok-domain>/.well-known/oauth-authorization-server: 404 404 Not Found` is not a problem in this workshop because that endpoint is intentionally not implemented. VS Code falls back to `/.well-known/openid-configuration`.

If metadata values such as `authorization_servers` are incorrect, unintended endpoints may open during the authorization flow.
Review settings using [Authorization Server Implementation ## Final Check](./02-implement-authorization-server.md#final-check).

### Authorization Flow Started but Not Completed

During repeated debugging, the authorization flow can remain stuck in an unfinished state.
Clicking the alarm icon at the bottom-right of VS Code may allow cancellation of the in-progress authorization flow.

![check notification](../img/03-call-mcp-tool-via-vscode/check-notification.png)

To clear caches such as cached client IDs, use the `removeDynamicAuthenticationProviders` command.

### VS Code State Looks Broken

Depending on the environment, VS Code may keep invalid cache and fail to refresh correctly.
In that case, try clearing cache with the following steps.

1. Open Command Palette (`F1` or `Command` + `Shift` + `P`)
2. Enter `removeDynamicAuthenticationProviders` and select `Authentication: Remove Dynamic Authentication Provider`
3. Check `http://localhost:9001` and click OK to clear token cache

If MCP server connection still fails, reloading the VS Code window can help.

1. Open Command Palette (`F1` or `Command` + `Shift` + `P`)
2. Enter `Reload Window` and select `Developer: Reload Window`
